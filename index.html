<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Excel Viewer v5.3 - Item Header Fix</title> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom Styles */
        :root {
            --bg-primary-light: #f3f4f6; /* gray-100 */
            --bg-secondary-light: #ffffff; /* white */
            --text-primary-light: #1f2937; /* gray-800 */
            --text-secondary-light: #4b5563; /* gray-600 */
            --border-light: #e5e7eb; /* gray-200 */
            --icon-light: #059669; /* emerald-600 */
            --nav-bg-light: #047857; /* emerald-700 */
            --nav-text-light: #ffffff;
            --footer-bg-light: #1e293b; /* slate-800 */
            --footer-text-light: #cbd5e1; /* slate-300 */
            --input-bg-light: #ffffff;
            --input-border-light: #d1d5db; /* gray-300 */
            --input-text-light: #1f2937;
            --input-placeholder-light: #9ca3af; /* gray-400 */
            --button-primary-bg-light: #10b981; /* emerald-500 */
            --button-primary-text-light: #ffffff;
            --file-item-hover-light: #f9fafb; /* gray-50 */
            --delete-icon-light: #ef4444; /* red-500 */
            --delete-icon-hover-light: #991b1b; /* red-800 */
            --delete-bg-hover-light: #fee2e2; /* red-100 */
            --scrollbar-track-light: #e5e7eb; /* gray-200 */
            --scrollbar-thumb-light: #9ca3af; /* gray-400 */
            --scrollbar-thumb-hover-light: #6b7280; /* gray-500 */
            --progress-bar-bg-light: #10b981; /* emerald-500 */
            --progress-track-bg-light: #e5e7eb; /* gray-200 */
            --modal-backdrop-light: rgba(107, 114, 128, 0.5); /* gray-600 with opacity */


            --bg-primary-dark: #1f2937; /* gray-800 */
            --bg-secondary-dark: #374151; /* gray-700 */
            --text-primary-dark: #f3f4f6; /* gray-100 */
            --text-secondary-dark: #d1d5db; /* gray-300 */
            --border-dark: #4b5563; /* gray-600 */
            --icon-dark: #34d399; /* emerald-400 */
            --nav-bg-dark: #065f46; /* emerald-800 */
            --nav-text-dark: #d1fae5; /* emerald-100 */
            --footer-bg-dark: #0f172a; /* slate-900 */
            --footer-text-dark: #94a3b8; /* slate-400 */
            --input-bg-dark: #4b5563; /* gray-600 */
            --input-border-dark: #6b7280; /* gray-500 */
            --input-text-dark: #f3f4f6;
            --input-placeholder-dark: #9ca3af; /* gray-400 */
            --button-primary-bg-dark: #34d399; /* emerald-400 */
            --button-primary-text-dark: #064e3b; /* emerald-900 */
            --file-item-hover-dark: #4b5563; /* gray-600 */
            --delete-icon-dark: #f87171; /* red-400 */
            --delete-icon-hover-dark: #fca5a5; /* red-300 */
            --delete-bg-hover-dark: #7f1d1d; /* red-900 */
            --scrollbar-track-dark: #374151; /* gray-700 */
            --scrollbar-thumb-dark: #6b7280; /* gray-500 */
            --scrollbar-thumb-hover-dark: #9ca3af; /* gray-400 */
            --progress-bar-bg-dark: #34d399; /* emerald-400 */
            --progress-track-bg-dark: #4b5563; /* gray-600 */
            --modal-backdrop-dark: rgba(0, 0, 0, 0.7);
        }

        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background-color: var(--bg-primary-light);
            color: var(--text-primary-light);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark body {
            background-color: var(--bg-primary-dark);
            color: var(--text-primary-dark);
        }

        /* Custom scrollbar for scrollable areas */
        #resultsArea::-webkit-scrollbar,
        #storedFilesList::-webkit-scrollbar,
        .max-h-60::-webkit-scrollbar, /* General class for other potential scroll areas */
        .max-h-72::-webkit-scrollbar,
        .modal-scrollable-content::-webkit-scrollbar { /* For modal content */
            width: 8px;
            height: 8px;
        }
        #resultsArea::-webkit-scrollbar-track,
        #storedFilesList::-webkit-scrollbar-track,
        .max-h-60::-webkit-scrollbar-track,
        .max-h-72::-webkit-scrollbar-track,
        .modal-scrollable-content::-webkit-scrollbar-track {
            background: var(--scrollbar-track-light);
            border-radius: 10px;
        }
        .dark #resultsArea::-webkit-scrollbar-track,
        .dark #storedFilesList::-webkit-scrollbar-track,
        .dark .max-h-60::-webkit-scrollbar-track,
        .dark .max-h-72::-webkit-scrollbar-track,
        .dark .modal-scrollable-content::-webkit-scrollbar-track {
            background: var(--scrollbar-track-dark);
        }

        #resultsArea::-webkit-scrollbar-thumb,
        #storedFilesList::-webkit-scrollbar-thumb,
        .max-h-60::-webkit-scrollbar-thumb,
        .max-h-72::-webkit-scrollbar-thumb,
        .modal-scrollable-content::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb-light);
            border-radius: 10px;
            border: 2px solid var(--scrollbar-track-light);
        }
        .dark #resultsArea::-webkit-scrollbar-thumb,
        .dark #storedFilesList::-webkit-scrollbar-thumb,
        .dark .max-h-60::-webkit-scrollbar-thumb,
        .dark .max-h-72::-webkit-scrollbar-thumb,
        .dark .modal-scrollable-content::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb-dark);
            border: 2px solid var(--scrollbar-track-dark);
        }

        #resultsArea::-webkit-scrollbar-thumb:hover,
        #storedFilesList::-webkit-scrollbar-thumb:hover,
        .max-h-60::-webkit-scrollbar-thumb:hover,
        .max-h-72::-webkit-scrollbar-thumb:hover,
        .modal-scrollable-content::-webkit-scrollbar-thumb:hover {
            background-color: var(--scrollbar-thumb-hover-light);
        }
        .dark #resultsArea::-webkit-scrollbar-thumb:hover,
        .dark #storedFilesList::-webkit-scrollbar-thumb:hover,
        .dark .max-h-60::-webkit-scrollbar-thumb:hover,
        .dark .max-h-72::-webkit-scrollbar-thumb:hover,
        .dark .modal-scrollable-content::-webkit-scrollbar-thumb:hover {
            background-color: var(--scrollbar-thumb-hover-dark);
        }

        /* Toast Notification Style */
        .toast-notification {
            padding: 0.75rem 1.25rem; border-radius: 0.5rem; color: white;
            font-size: 0.9rem; z-index: 1000; opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: flex;
            align-items: center; min-width: 250px;
        }
        .dark .toast-notification { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
        .toast-notification.show { opacity: 1; transform: translateX(0); }
        .toast-success { background-color: #10b981; } 
        .toast-error { background-color: #ef4444; }
        .toast-info { background-color: #3b82f6; }
        .toast-warning { background-color: #f59e0b; }
        .dark .toast-success { background-color: #34d399; color: #064e3b; }
        .dark .toast-error { background-color: #f87171; color: #7f1d1d; }
        .dark .toast-info { background-color: #60a5fa; color: #1e40af; }
        .dark .toast-warning { background-color: #fbbf24; color: #78350f; }
        .toast-notification .icon { margin-right: 0.75rem; font-size: 1.25rem; }

        /* File list items */
        .file-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-light);
            transition: background-color 0.2s ease; color: var(--text-secondary-light);
        }
        .dark .file-item { border-bottom-color: var(--border-dark); color: var(--text-secondary-dark); }
        .file-item:hover { background-color: var(--file-item-hover-light); }
        .dark .file-item:hover { background-color: var(--file-item-hover-dark); }
        .file-item:last-child { border-bottom: none; }
        .file-item .file-name-text {
            word-break: break-all; margin-right: 1rem;
            color: var(--text-primary-light); font-size: 0.9rem;
        }
        .dark .file-item .file-name-text { color: var(--text-primary-dark); }
        .delete-button {
            cursor: pointer; color: var(--delete-icon-light);
            transition: color 0.2s ease, transform 0.2s ease, background-color 0.2s ease;
            padding: 0.375rem; border-radius: 0.375rem;
        }
        .dark .delete-button { color: var(--delete-icon-dark); }
        .delete-button:hover {
            color: var(--delete-icon-hover-light); transform: scale(1.1);
            background-color: var(--delete-bg-hover-light);
        }
        .dark .delete-button:hover {
            color: var(--delete-icon-hover-dark); background-color: var(--delete-bg-hover-dark);
        }

        /* Theme Toggle Switch */
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 26px; position: relative; width: 50px; }
        .theme-switch input { display:none; }
        .slider {
            background-color: #ccc; bottom: 0; cursor: pointer; left: 0;
            position: absolute; right: 0; top: 0; transition: .4s;
        }
        .slider:before {
            background-color: #fff; bottom: 3px; content: ""; height: 20px;
            left: 3px; position: absolute; transition: .4s; width: 20px;
        }
        input:checked + .slider { background-color: var(--icon-light); }
        .dark input:checked + .slider { background-color: var(--icon-dark); }
        input:checked + .slider:before { transform: translateX(24px); }
        .slider.round { border-radius: 26px; }
        .slider.round:before { border-radius: 50%; }
        .theme-switch-wrapper .fa-moon, .theme-switch-wrapper .fa-sun {
            color: var(--nav-text-light); margin: 0 8px; font-size: 1rem;
        }
        .dark .theme-switch-wrapper .fa-moon, .dark .theme-switch-wrapper .fa-sun { color: var(--nav-text-dark); }

        #loadMoreButton {
             background-color: var(--button-primary-bg-light); color: var(--button-primary-text-light);
        }
         .dark #loadMoreButton {
             background-color: var(--button-primary-bg-dark); color: var(--button-primary-text-dark);
         }
        #dataMapModal { background-color: var(--modal-backdrop-light); }
        .dark #dataMapModal { background-color: var(--modal-backdrop-dark); }
        .result-card-bg.clickable-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); 
            border-color: var(--icon-light); 
        }
        .dark .result-card-bg.clickable-card:hover { border-color: var(--icon-dark); }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="shadow-lg sticky top-0 z-50" style="background-color: var(--nav-bg-light);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl sm:text-3xl font-bold flex items-center" style="color: var(--nav-text-light);">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 7V4h16v3"></path><path d="M4 12h16"></path><path d="M4 17h16"></path><path d="M8 4v16"></path><path d="M16 4v16"></path>
                        </svg>
                        Offline Excel Viewer
                    </span>
                </div>
                <div class="theme-switch-wrapper">
                    <i class="fas fa-sun"></i>
                    <label class="theme-switch" for="themeToggleCheckbox">
                        <input type="checkbox" id="themeToggleCheckbox" />
                        <div class="slider round"></div>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </div>
        </div>
    </nav>
     <script>
        const initialTheme = localStorage.getItem('theme');
        const initialPrefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        const isInitiallyDark = initialTheme === 'dark' || (!initialTheme && initialPrefersDarkScheme.matches);
         if (isInitiallyDark) {
             document.documentElement.classList.add('dark');
             if (document.querySelector('nav')) { 
                 document.querySelector('nav').style.backgroundColor = 'var(--nav-bg-dark)';
                 document.querySelector('nav span').style.color = 'var(--nav-text-dark)';
                 document.querySelectorAll('.theme-switch-wrapper i').forEach(i => i.style.color = 'var(--nav-text-dark)');
             }
         } else {
            if (document.querySelector('nav')) { 
                 document.querySelector('nav').style.backgroundColor = 'var(--nav-bg-light)';
                 document.querySelector('nav span').style.color = 'var(--nav-text-light)';
                 document.querySelectorAll('.theme-switch-wrapper i').forEach(i => i.style.color = 'var(--nav-text-light)');
            }
         }
    </script>

    <main class="flex-grow container mx-auto px-4 py-6 sm:px-6 lg:px-8 w-full">
        <section class="mb-8 p-4 sm:p-6 rounded-xl shadow-xl" style="background-color: var(--bg-secondary-light);">
            <label for="searchBox" class="block text-lg font-semibold mb-2" style="color: var(--text-primary-light);">
                <i class="fas fa-search mr-2" style="color: var(--icon-light);"></i>Search Data
            </label>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search" style="color: var(--input-placeholder-light);"></i>
                </div>
                <input type="text" id="searchBox" placeholder="Type keywords to search all stored Excel data..."
                       class="w-full pl-10 pr-4 py-3 border rounded-lg focus:ring-2 shadow-sm text-base transition-shadow hover:shadow-md"
                       style="background-color: var(--input-bg-light); border-color: var(--input-border-light); color: var(--input-text-light); --tw-ring-color: var(--icon-light);"
                       onfocus="this.style.borderColor = 'var(--icon-light)';"
                       onblur="this.style.borderColor = 'var(--input-border-light)';">
            </div>
            <p id="searchStatus" class="text-sm mt-2 h-5" style="color: var(--text-secondary-light);"></p>
        </section>

        <section class="mb-8">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold" style="color: var(--text-primary-light);">Results</h2>
            </div>
            <div id="resultsArea" class="min-h-[200px] max-h-[70vh] overflow-y-auto pr-2">
                <div class="default-message text-center italic mt-10 text-lg p-6 rounded-lg shadow-md"
                     style="display: block; background-color: var(--bg-secondary-light); color: var(--text-secondary-light);">
                    <i class="fas fa-file-upload mr-2 text-2xl block mb-2" style="color: var(--input-placeholder-light);"></i>Upload an Excel file to begin searching.
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <section class="p-4 sm:p-6 rounded-xl shadow-xl flex flex-col" style="background-color: var(--bg-secondary-light);">
                <h2 class="text-xl font-semibold mb-4 flex items-center" style="color: var(--text-primary-light);">
                    <i class="fas fa-upload mr-2" style="color: var(--icon-light);"></i>Upload New File
                </h2>
                <div class="space-y-4 flex-grow flex flex-col justify-between">
                    <div>
                        <label for="fileInput" class="block text-sm font-medium mb-1" style="color: var(--text-primary-light);">Choose Excel File (.xlsx, .xls)</label>
                        <input type="file" id="fileInput" accept=".xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
                               class="block w-full text-sm file:mr-4 file:py-2.5 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold cursor-pointer border rounded-lg p-1 transition-colors"
                               style="color: var(--text-secondary-light); border-color: var(--input-border-light); --file-bg: var(--bg-primary-light); --file-text: var(--icon-light);"
                               onmouseover="this.style.setProperty('--file-bg', 'var(--bg-primary-dark)')"
                               onmouseout="this.style.setProperty('--file-bg', 'var(--bg-primary-light)')">
                        <p class="text-xs mt-1" style="color: var(--text-secondary-light);">Max file size: 10 MB</p>
                    </div>
                    <div id="progressContainer" class="mt-3" style="display: none;">
                        <label id="progressLabel" class="block text-sm font-medium mb-1" style="color: var(--text-primary-light);">Processing...</label>
                        <div class="w-full rounded-full h-3" style="background-color: var(--progress-track-bg-light);">
                            <div id="progressBar" class="h-3 rounded-full transition-all duration-300 ease-out" style="width: 0%; background-color: var(--progress-bar-bg-light);"></div>
                        </div>
                    </div>
                    <div id="statusMessageContainer" class="mt-2 h-5">
                        <p id="statusMessage" class="text-sm text-center font-medium" style="color: var(--text-primary-light);"></p>
                    </div>
                </div>
            </section>

            <section class="p-4 sm:p-6 rounded-xl shadow-xl flex flex-col" style="background-color: var(--bg-secondary-light);">
                <h2 class="text-xl font-semibold mb-4 flex items-center" style="color: var(--text-primary-light);">
                    <i class="fas fa-database mr-2" style="color: var(--icon-light);"></i>Stored Files
                </h2>
                <div id="storedFilesList" class="border rounded-lg max-h-72 overflow-y-auto flex-grow" style="border-color: var(--border-light);">
                    <div class="file-item italic p-4" id="noFilesMessage" style="color: var(--text-secondary-light);">
                        <i class="fas fa-folder-open mr-2"></i>No files stored yet.
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="text-center py-4 mt-auto shadow-inner" style="background-color: var(--footer-bg-light); color: var(--footer-text-light);">
        <p class="text-sm">Created By YashPathak09</p>
        <p class="text-xs mt-1">App Status: <span id="footerStatus" class="font-semibold">Initializing...</span></p>
    </footer>

    <div id="toastContainer" class="fixed bottom-5 right-5 z-[1001] space-y-2 w-auto max-w-md"></div>

    <div id="dataMapModal" class="fixed inset-0 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-[1002] hidden p-4" style="background-color: var(--modal-backdrop-light);">
        <div id="dataMapModalContentContainer" class="relative p-5 sm:p-6 border w-full max-w-xl md:max-w-2xl lg:max-w-3xl shadow-xl rounded-xl transform transition-all" style="background-color: var(--bg-secondary-light); border-color: var(--border-light);">
            <div class="flex justify-between items-center pb-3 border-b" style="border-color: var(--border-light);">
                <h3 id="dataMapModalTitle" class="text-xl font-semibold" style="color: var(--text-primary-light);">Data Details</h3>
                <button id="closeDataMapModal" class="p-1 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600" style="color: var(--text-secondary-light);" aria-label="Close modal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="mt-4 space-y-5 modal-scrollable-content max-h-[70vh] overflow-y-auto pr-2">
                <section id="modalSelectedItemDetailsSection">
                    <h4 class="text-lg font-semibold mb-2 flex items-center" style="color: var(--icon-light);">
                        <i class="fas fa-info-circle mr-2"></i>Selected Item
                    </h4>
                    <div id="modalSelectedItemContent" class="space-y-1 text-sm p-3 rounded-md border" style="border-color: var(--border-light); background-color: var(--bg-primary-light);">
                        {/* Content dynamically populated by JS. */}
                    </div>
                </section>

                <section id="modalCompanyInsightsSection" class="pt-4 border-t" style="border-color: var(--border-light);">
                    <h4 class="text-lg font-semibold mb-2 flex items-center" style="color: var(--icon-light);">
                        <i class="fas fa-building mr-2"></i>Company Insights
                    </h4>
                    <div id="modalCompanyInsightsContent" class="space-y-1 text-sm p-3 rounded-md border" style="border-color: var(--border-light); background-color: var(--bg-primary-light);">
                         {/* Content dynamically populated by JS. */}
                    </div>
                </section>

                <section id="modalSimilarItemsSection" class="pt-4 border-t" style="border-color: var(--border-light);">
                    <h4 class="text-lg font-semibold mb-2 flex items-center" style="color: var(--icon-light);">
                        <i class="fas fa-copy mr-2"></i>Related Items
                    </h4>
                    <div id="modalSimilarItemsContent" class="space-y-2 text-sm p-3 rounded-md border" style="border-color: var(--border-light); background-color: var(--bg-primary-light);">
                        {/* Content dynamically populated by JS. */}
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/dexie@4.0.1/dist/dexie.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>

    <script>
        // --- Theme Management ---
        const themeToggle = document.getElementById('themeToggleCheckbox');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

        function applyTheme(theme) {
            const isDarkMode = theme === 'dark';
            
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                themeToggle.checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                themeToggle.checked = false;
            }

            document.querySelector('nav').style.backgroundColor = isDarkMode ? 'var(--nav-bg-dark)' : 'var(--nav-bg-light)';
            document.querySelector('nav span').style.color = isDarkMode ? 'var(--nav-text-dark)' : 'var(--nav-text-light)';
            document.querySelectorAll('.theme-switch-wrapper i').forEach(i => i.style.color = isDarkMode ? 'var(--nav-text-dark)' : 'var(--nav-text-light)');
            document.querySelectorAll('section, .default-message').forEach(el => el.style.backgroundColor = isDarkMode ? 'var(--bg-secondary-dark)' : 'var(--bg-secondary-light)');
            document.querySelectorAll('label, h2, #statusMessage, .file-item .file-name-text').forEach(el => el.style.color = isDarkMode ? 'var(--text-primary-dark)' : 'var(--text-primary-light)');
            document.querySelectorAll('#searchStatus, #fileInput, .default-message i, .file-item, #noFilesMessage, p.text-xs').forEach(el => el.style.color = isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)');
            document.querySelectorAll('section > h2 > .fa-search, section > h2 > .fa-upload, section > h2 > .fa-database').forEach(el => el.style.color = isDarkMode ? 'var(--icon-dark)' : 'var(--icon-light)'); 
            const searchBoxEl = document.getElementById('searchBox');
            searchBoxEl.style.backgroundColor = isDarkMode ? 'var(--input-bg-dark)' : 'var(--input-bg-light)';
            searchBoxEl.style.borderColor = isDarkMode ? 'var(--input-border-dark)' : 'var(--input-border-light)';
            searchBoxEl.style.color = isDarkMode ? 'var(--input-text-dark)' : 'var(--input-text-light)';
            searchBoxEl.style.setProperty('--tw-ring-color', isDarkMode ? 'var(--icon-dark)' : 'var(--icon-light)');
            
            const searchIconInSearchBox = searchBoxEl.parentElement.querySelector('.fa-search');
            if(searchIconInSearchBox) searchIconInSearchBox.style.color = isDarkMode ? 'var(--input-placeholder-dark)' : 'var(--input-placeholder-light)';


            document.querySelector('footer').style.backgroundColor = isDarkMode ? 'var(--footer-bg-dark)' : 'var(--footer-bg-light)';
            document.querySelector('footer').style.color = isDarkMode ? 'var(--footer-text-dark)' : 'var(--footer-text-light)';
            document.getElementById('storedFilesList').style.borderColor = isDarkMode ? 'var(--border-dark)' : 'var(--border-light)';
            const fileInputEl = document.getElementById('fileInput');
            fileInputEl.style.borderColor = isDarkMode ? 'var(--input-border-dark)' : 'var(--input-border-light)';
            fileInputEl.style.setProperty('--file-bg', isDarkMode ? 'var(--bg-primary-dark)' : 'var(--bg-primary-light)');
            fileInputEl.style.setProperty('--file-text', isDarkMode ? 'var(--icon-dark)' : 'var(--icon-light)');
            document.querySelector('#progressContainer > div').style.backgroundColor = isDarkMode ? 'var(--progress-track-bg-dark)' : 'var(--progress-track-bg-light)';
            document.getElementById('progressBar').style.backgroundColor = isDarkMode ? 'var(--progress-bar-bg-dark)' : 'var(--progress-bar-bg-light)';

            document.querySelectorAll('.result-card-bg').forEach(el => {
                el.style.backgroundColor = isDarkMode ? 'var(--bg-secondary-dark)' : 'var(--bg-secondary-light)';
            });
             document.querySelectorAll('.result-card-bg .flex-shrink-0').forEach(el => {
                 el.style.backgroundColor = isDarkMode ? 'var(--icon-dark)' : 'var(--icon-light)';
                 el.style.color = isDarkMode ? 'var(--button-primary-text-dark)' : 'var(--button-primary-text-light)';
             });
            document.querySelectorAll('.result-card-bg h3.result-title').forEach(el => {
                 el.style.color = isDarkMode ? 'var(--icon-dark)' : 'var(--icon-light)';
            });
            document.querySelectorAll('.result-card-bg p.result-subtitle').forEach(el => {
                 el.style.color = isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)';
            });
            document.querySelectorAll('.result-card-bg p.result-source-text').forEach(el => {
                 el.style.color = isDarkMode ? '#9ca3af' : '#a1a1aa';
            });
             document.querySelectorAll('.result-card-bg div.result-details-grid').forEach(el => {
                el.style.borderColor = isDarkMode ? 'var(--border-dark)' : 'var(--border-light)';
            });
            document.querySelectorAll('.result-card-bg .result-detail-header').forEach(el => {
                 el.style.color = isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)';
            });
             document.querySelectorAll('.result-card-bg .result-detail-value').forEach(el => {
                 if (!el.dataset.styledValue) { 
                    el.style.color = isDarkMode ? 'var(--text-primary-dark)' : 'var(--text-primary-light)';
                 } else { 
                    const lowerHeader = el.dataset.header ? el.dataset.header.toLowerCase() : "";
                    const cellValue = el.dataset.value || "";
                    if (lowerHeader === 'mrp' || lowerHeader.includes('price') || lowerHeader.includes('rate')) {
                        el.style.color = isDarkMode ? '#60a5fa' : '#2563eb'; 
                    } else if (lowerHeader === 'stock' || lowerHeader.includes('qty') || lowerHeader.includes('quantity') || lowerHeader.includes('bal')) {
                        const stockVal = parseInt(cellValue);
                        if (!isNaN(stockVal)) {
                            if (stockVal > 20) el.style.color = isDarkMode ? '#34d399' : '#059669';
                            else if (stockVal > 0) el.style.color = isDarkMode ? '#facc15' : '#f59e0b'; 
                            else el.style.color = isDarkMode ? '#f87171' : '#ef4444';
                        }
                    }
                 }
            });

            const loadMoreButton = document.getElementById('loadMoreButton');
            if(loadMoreButton) {
                loadMoreButton.style.backgroundColor = isDarkMode ? 'var(--button-primary-bg-dark)' : 'var(--button-primary-bg-light)';
                loadMoreButton.style.color = isDarkMode ? 'var(--button-primary-text-dark)' : 'var(--button-primary-text-light)';
                loadMoreButton.style.setProperty('--tw-ring-color', isDarkMode ? 'var(--icon-dark)' : 'var(--icon-light)');
            }

            const dataMapModalEl = document.getElementById('dataMapModal');
            const dataMapModalContentContainer = document.getElementById('dataMapModalContentContainer');
            if (dataMapModalEl && dataMapModalContentContainer) {
                dataMapModalEl.style.backgroundColor = isDarkMode ? 'var(--modal-backdrop-dark)' : 'var(--modal-backdrop-light)';
                dataMapModalContentContainer.style.backgroundColor = isDarkMode ? 'var(--bg-secondary-dark)' : 'var(--bg-secondary-light)';
                dataMapModalContentContainer.style.borderColor = isDarkMode ? 'var(--border-dark)' : 'var(--border-light)';
                
                dataMapModalContentContainer.querySelector('#dataMapModalTitle').style.color = isDarkMode ? 'var(--text-primary-dark)' : 'var(--text-primary-light)';
                const closeBtn = dataMapModalContentContainer.querySelector('#closeDataMapModal');
                closeBtn.style.color = isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)';
                closeBtn.onmouseover = function() { this.style.backgroundColor = isDarkMode ? 'var(--input-bg-dark)' : 'var(--file-item-hover-light)'; };
                closeBtn.onmouseout = function() { this.style.backgroundColor = 'transparent'; };

                dataMapModalContentContainer.querySelectorAll('section > h4').forEach(h => h.style.color = isDarkMode ? 'var(--icon-dark)' : 'var(--icon-light)');
                dataMapModalContentContainer.querySelectorAll('section > div[id*="Content"]').forEach(div => {
                    div.style.borderColor = isDarkMode ? 'var(--border-dark)' : 'var(--border-light)';
                    div.style.backgroundColor = isDarkMode ? 'var(--bg-primary-dark)' : 'var(--bg-primary-light)';
                });
                dataMapModalContentContainer.querySelectorAll('.modal-loading, .modal-no-data, .modal-item-detail span:first-child, .modal-company-type span:first-child, .modal-similar-item-loc, .modal-item-detail > .text-xs.italic, #modalCompanyInsightsContent > .text-xs.italic, #modalSimilarItemsContent > .text-xs.italic').forEach(el => {
                    el.style.color = isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)';
                });
                 dataMapModalContentContainer.querySelectorAll('.modal-item-detail span:last-child, .modal-company-total, .modal-company-type span:last-child, .modal-similar-item-name, #modalCompanyInsightsContent > .font-semibold, #modalSimilarItemsContent > .font-medium').forEach(el => {
                    el.style.color = isDarkMode ? 'var(--text-primary-dark)' : 'var(--text-primary-light)';
                });

                dataMapModalContentContainer.querySelector('.flex.justify-between.items-center.pb-3.border-b').style.borderColor = isDarkMode ? 'var(--border-dark)' : 'var(--border-light)';
                dataMapModalContentContainer.querySelectorAll('section[id*="Section"].border-t').forEach(sec => {
                     sec.style.borderColor = isDarkMode ? 'var(--border-dark)' : 'var(--border-light)';
                });
            }
             if (allSearchResults && resultsDisplayed > 0) {
                const currentVisibleResults = Array.from(resultsArea.querySelectorAll('.result-card-bg'));
                const startIndex = allSearchResults.length - resultsDisplayed; 
                const resultsToReProcess = allSearchResults.slice(startIndex, startIndex + currentVisibleResults.length);
                
                currentVisibleResults.forEach((rowEl, index) => {
                    const row = resultsToReProcess[index];
                    if (!row) return;
                    const detailValues = rowEl.querySelectorAll('.result-detail-value');
                    detailValues.forEach(valEl => {
                        const header = valEl.dataset.header;
                        const cellValue = valEl.dataset.value;
                        if (header && cellValue && valEl.dataset.styledValue) { 
                             const lowerHeader = header.toLowerCase();
                             if (lowerHeader === 'mrp' || lowerHeader.includes('price') || lowerHeader.includes('rate')) {
                                valEl.style.color = isDarkMode ? '#60a5fa' : '#2563eb'; 
                            } else if (lowerHeader === 'stock' || lowerHeader.includes('qty') || lowerHeader.includes('quantity') || lowerHeader.includes('bal')) {
                                const stockVal = parseInt(cellValue);
                                if (!isNaN(stockVal)) {
                                    if (stockVal > 20) valEl.style.color = isDarkMode ? '#34d399' : '#059669';
                                    else if (stockVal > 0) valEl.style.color = isDarkMode ? '#facc15' : '#f59e0b'; 
                                    else valEl.style.color = isDarkMode ? '#f87171' : '#ef4444';
                                }
                            }
                        }
                    });
                });

             } else if (searchBox.value.trim().length === 0) {
                 updateResultsDisplay([]);
             }
             loadStoredFilesList();
        }

         document.addEventListener('DOMContentLoaded', () => {
             if (!localStorage.getItem('theme')) {
                applyTheme(prefersDarkScheme.matches ? 'dark' : 'light');
                localStorage.setItem('theme', prefersDarkScheme.matches ? 'dark' : 'light');
             } else {
                 applyTheme(localStorage.getItem('theme'));
             }
             console.log("DOM Content Loaded. Initializing v5.3 with Item Header Fix...");
             initializeDataMapModalListeners(); 
             loadStoredFilesList();
             updateResultsDisplay([]);
             updateFooterStatus('Ready');
             console.log("Initialization complete.");
         });

        themeToggle.addEventListener('change', function() {
            const newTheme = this.checked ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });
        prefersDarkScheme.addEventListener('change', (e) => {
            if (!localStorage.getItem('theme')) { 
                applyTheme(e.matches ? 'dark' : 'light');
                localStorage.setItem('theme', e.matches ? 'dark' : 'light');
            }
        });


        // --- DOM Elements ---
        const fileInput = document.getElementById('fileInput');
        const searchBox = document.getElementById('searchBox');
        const resultsArea = document.getElementById('resultsArea');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const progressLabel = document.getElementById('progressLabel');
        const statusMessage = document.getElementById('statusMessage');
        const storedFilesList = document.getElementById('storedFilesList');
        const noFilesMessageElement = document.getElementById('noFilesMessage');
        const defaultResultsMessageElement = resultsArea.querySelector('.default-message');
        const toastContainer = document.getElementById('toastContainer');
        const searchStatus = document.getElementById('searchStatus');
        const footerStatus = document.getElementById('footerStatus');

        const dataMapModal = document.getElementById('dataMapModal');
        const dataMapModalTitle = document.getElementById('dataMapModalTitle');
        const closeDataMapModalBtn = document.getElementById('closeDataMapModal');
        const modalSelectedItemContent = document.getElementById('modalSelectedItemContent');
        const modalCompanyInsightsContent = document.getElementById('modalCompanyInsightsContent');
        const modalSimilarItemsContent = document.getElementById('modalSimilarItemsContent');

        // --- Constants ---
        const DB_NAME = 'ExcelDataDB_V5_3_ItemHeaderFix'; 
        const STORE_NAME = 'excelDataStoreV5_3_ItemHeaderFix';
        const METADATA_STORE_NAME = 'fileMetadataV5_3_ItemHeaderFix';
        const MAX_FILE_SIZE = 10 * 1024 * 1024; 
        const SEARCH_DEBOUNCE_MS = 300;
        const INITIAL_DISPLAY_COUNT = 200;
        const LOAD_MORE_CHUNK_SIZE = 100;
        const MAX_QUERY_RESULTS_FETCH = 10000;

        // --- Dexie Database Setup ---
        const db = new Dexie(DB_NAME);
        db.version(10).stores({ 
            [STORE_NAME]: '++id, fileName, *_searchableTokens', 
            [METADATA_STORE_NAME]: 'fileName, headers, originalFileName, sheetName'
        }).upgrade(tx => {
            console.log("Applying Dexie schema version 10 (Item Header Fix)");
        });

        // --- Global State ---
        let searchTimeoutId = null;
        let allSearchResults = [];
        let resultsDisplayed = 0;

        // --- Event Listeners ---
        fileInput.addEventListener('change', handleFileUpload);
        searchBox.addEventListener('input', () => {
            clearTimeout(searchTimeoutId);
            searchTimeoutId = setTimeout(handleSearch, SEARCH_DEBOUNCE_MS);
            searchStatus.textContent = 'Typing...';
        });

        // --- Utility: HTML Escaping ---
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/[&<>"']/g, function (match) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
            });
        }

        // --- Toast Notifications ---
        function showToast(message, type = 'info', duration = 3500) {
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`; 
            let iconClass = 'fas fa-info-circle';
            if (type === 'success') iconClass = 'fas fa-check-circle';
            if (type === 'error') iconClass = 'fas fa-times-circle';
            if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
            toast.innerHTML = `<i class="${iconClass} icon"></i><span>${escapeHTML(message)}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10); 
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, duration);
        }

        // --- File Upload Handling ---
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            resetUploadUI();

            if (!isValidFile(file)) {
                showToast(`Invalid file. Please upload .xlsx or .xls (Max ${MAX_FILE_SIZE / 1024 / 1024}MB).`, 'error');
                resetFileInput(); return;
            }
            showProgressState('Reading file...', 10); updateFooterStatus(`Reading ${file.name}...`);
            try {
                const arrayBuffer = await readFileAsArrayBuffer(file);
                showProgressState('Parsing Excel data...', 30); updateFooterStatus(`Parsing ${file.name}...`);
                await new Promise(resolve => setTimeout(resolve, 50));
                const workbookData = await parseExcelData(arrayBuffer);
                showProgressState('Processing data...', 60); updateFooterStatus(`Processing ${file.name}...`);

                if (!workbookData || workbookData.length === 0) throw new Error("Workbook empty or unreadable.");
                let sheetToProcess = workbookData.find(sheet => sheet.data && sheet.data.length > 0) || workbookData[0];
                
                const { sheetName, headers, data } = sheetToProcess;
                const fileIdentifier = `${file.name}::${sheetName}`;
                const existingMeta = await db[METADATA_STORE_NAME].get(fileIdentifier);
                if (existingMeta) {
                    if (!confirm(`Data for "${file.name}" (Sheet: "${sheetName}") already exists. Overwrite?`)) {
                        throw new Error("Storage cancelled by user.");
                    }
                    await deleteFileDataInternal(fileIdentifier, false);
                }
                showProgressState('Storing data locally...', 80); updateFooterStatus(`Storing data from ${file.name}...`);
                await storeData(fileIdentifier, file.name, sheetName, headers, data);
                showProgressState('Complete!', 100);
                const storedRowCount = data ? data.length : 0;
                showToast(`"${file.name}" (Sheet: "${sheetName}") stored successfully! (${storedRowCount} rows)`, 'success');
                await loadStoredFilesList(); 
                 if (searchBox.value.trim().length > 0) handleSearch(); else updateResultsDisplay([]);
            } catch (error) {
                console.error("Error processing file:", error);
                showToast(`Error: ${error.message}`, 'error'); updateFooterStatus('Error processing file');
            } finally {
                resetFileInput();
                setTimeout(() => { progressContainer.style.display = 'none'; progressBar.style.width = '0%'; statusMessage.textContent = ''; }, 2500);
                updateFooterStatus('Ready');
            }
        }
        function resetUploadUI() { statusMessage.textContent = ''; progressContainer.style.display = 'none'; progressBar.style.width = '0%'; }
        function resetFileInput() { fileInput.value = ''; }
        function showProgressState(message, percentage) { progressContainer.style.display = 'block'; progressLabel.textContent = message; progressBar.style.width = `${percentage}%`; statusMessage.textContent = percentage === 100 ? message : '';}
        function isValidFile(file) { const ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase(); return ['.xlsx', '.xls'].includes(ext) && file.size <= MAX_FILE_SIZE; }
        function readFileAsArrayBuffer(file) { return new Promise((resolve, reject) => { const r = new FileReader(); r.onload = e => resolve(e.target.result); r.onerror = e => reject(new Error("Failed to read file.")); r.readAsArrayBuffer(file); });}
        function parseExcelData(arrayBuffer) { 
            return new Promise((resolve, reject) => {
                try {
                    const workbook = XLSX.read(arrayBuffer, { type: 'array', cellDates: true, raw: true }); 
                    const results = workbook.SheetNames.map(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const rowsArray = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "", raw: true });
                        if (rowsArray.length === 0) return { sheetName, headers: [], data: [] };
                        let headerRowIndex = rowsArray.findIndex(row => row.some(cell => cell !== ""));
                        if (headerRowIndex === -1) return { sheetName, headers: [], data: [] }; 
                        
                        const headers = rowsArray[headerRowIndex].map(h => String(h || "").trim());
                        const data = rowsArray.slice(headerRowIndex + 1).map(rowArr => {
                            let rowData = {};
                            headers.forEach((header, index) => {
                                const rawValue = rowArr[index];
                                if (rawValue instanceof Date && !isNaN(rawValue)) rowData[header] = rawValue.toISOString();
                                else if (rawValue !== undefined && rawValue !== null) rowData[header] = typeof rawValue === 'object' ? String(rawValue) : rawValue;
                                else rowData[header] = ""; 
                            });
                            return rowData;
                        }).filter(row => Object.values(row).some(value => value !== "" && value !== null && value !== undefined)); 
                        return { sheetName, headers, data };
                    });
                    resolve(results);
                } catch (error) { reject(new Error(`Failed to parse Excel: ${error.message}`)); }
            });
        }
        async function storeData(fileIdentifier, originalFileName, sheetName, headers, data) { 
            try {
                const dataToStore = data.map(row => {
                     const searchableTokens = new Set();
                    Object.values(row).forEach(val => {
                         if (val !== undefined && val !== null) {
                             String(val).toLowerCase().split(/\s+/).filter(token => token.length > 0).forEach(token => searchableTokens.add(token));
                         }
                     });
                    originalFileName.toLowerCase().split(/\s+/).filter(token => token.length > 0).forEach(token => searchableTokens.add(token));
                    sheetName.toLowerCase().split(/\s+/).filter(token => token.length > 0).forEach(token => searchableTokens.add(token));
                    return { ...row, fileName: fileIdentifier, _searchableTokens: Array.from(searchableTokens) };
                });
                await db[METADATA_STORE_NAME].put({ fileName: fileIdentifier, originalFileName, sheetName, headers });
                const chunkSize = 10000;
                 for (let i = 0; i < dataToStore.length; i += chunkSize) {
                    await db[STORE_NAME].bulkPut(dataToStore.slice(i, i + chunkSize));
                 }
            } catch (error) {
                console.error("Error storing data:", error);
                await db[METADATA_STORE_NAME].delete(fileIdentifier).catch(e => {});
                await db[STORE_NAME].where('fileName').equals(fileIdentifier).delete().catch(e => {});
                throw new Error(`Failed to store data: ${error.message}`);
            }
        }

        // --- Search Functionality ---
        async function handleSearch() { 
            const query = searchBox.value.trim().toLowerCase();
            searchStatus.textContent = 'Searching...'; updateFooterStatus('Searching...');
            if (query.length === 0) { allSearchResults = []; resultsDisplayed = 0; updateResultsDisplay([]); searchStatus.textContent = ''; updateFooterStatus('Ready'); return; }
            const startTime = performance.now();
            try {
                const keywords = query.split(/\s+/).filter(k => k.length > 0);
                 if (keywords.length === 0) { allSearchResults = []; resultsDisplayed = 0; updateResultsDisplay([]); searchStatus.textContent = ''; updateFooterStatus('Ready'); return; }
                let fetchedResults = await db[STORE_NAME].where('_searchableTokens').equals(keywords[0]).limit(MAX_QUERY_RESULTS_FETCH).toArray();
                if (keywords.length > 1) {
                    fetchedResults = fetchedResults.filter(row => keywords.slice(1).every(kw => row._searchableTokens && row._searchableTokens.includes(kw)));
                }
                allSearchResults = fetchedResults; resultsDisplayed = 0; 
                const duration = (performance.now() - startTime).toFixed(1);
                searchStatus.textContent = `Found ${allSearchResults.length} results in ${duration} ms.`;
                displayResultsChunk(INITIAL_DISPLAY_COUNT);
            } catch (error) {
                console.error("Search error:", error); showToast("Error performing search.", 'error');
                allSearchResults = []; resultsDisplayed = 0; updateResultsDisplay([]); searchStatus.textContent = 'Search error.';
            } finally { updateFooterStatus('Ready'); }
        }


        // --- UI Update Functions ---
        async function displayResultsChunk(count) {
            const startIndex = resultsDisplayed;
            const endIndex = Math.min(startIndex + count, allSearchResults.length);
            const resultsChunk = allSearchResults.slice(startIndex, endIndex);
            const fragment = document.createDocumentFragment();
            const isDarkMode = document.documentElement.classList.contains('dark');

            if (startIndex === 0) {
                resultsArea.innerHTML = '';
                 if (allSearchResults.length === 0) { updateResultsDisplay([]); return; }
            } else {
                 const existingLoadMore = resultsArea.querySelector('#loadMoreButton');
                 if (existingLoadMore) existingLoadMore.remove();
            }
             const fileIdentifiers = [...new Set(allSearchResults.map(row => row.fileName))]; 
             const allMetadataArray = await db[METADATA_STORE_NAME].where('fileName').anyOf(fileIdentifiers).toArray();
             const metadataMap = new Map(allMetadataArray.map(m => [m.fileName, m]));

            resultsChunk.forEach(row => {
                const rowEl = document.createElement('div');
                rowEl.className = `result-card-bg clickable-card rounded-xl shadow-lg p-4 sm:p-5 mb-4 transition-all duration-300 ease-in-out hover:shadow-2xl transform hover:-translate-y-1 border border-transparent`;
                rowEl.style.backgroundColor = isDarkMode ? 'var(--bg-secondary-dark)' : 'var(--bg-secondary-light)';
                rowEl.style.cursor = 'pointer'; 
                rowEl.dataset.rowId = row.id; 
                rowEl.dataset.fileName = row.fileName;
                rowEl.addEventListener('click', handleResultCardClick);

                const meta = metadataMap.get(row.fileName);
                const headers = meta ? meta.headers : Object.keys(row).filter(k => !k.startsWith('_') && k !== 'id' && k !== 'fileName');
                let mainTitle = 'N/A', subTitle = '';
                 if (headers.length > 0) {
                    const potTitleH = ['name', 'item name', 'product', 'description', 'title', 'item']; // Added 'item'
                    let titleH = headers.find(h => potTitleH.some(pt => h.toLowerCase().trim() === pt.toLowerCase().trim() || h.toLowerCase().trim().includes(pt.toLowerCase().trim()))) || headers[0]; 
                    mainTitle = row[titleH] !== undefined && row[titleH] !== null ? String(row[titleH]) : 'Unnamed Item';
                    const potSubTitleH = ['id', 'code', 'sku', 'item code', 'product id'];
                    let subTitleH = headers.find(h => potSubTitleH.some(pst => h.toLowerCase().includes(pst)) && h !== titleH);
                    if (subTitleH) subTitle = row[subTitleH] !== undefined && row[subTitleH] !== null ? `${escapeHTML(String(subTitleH))}: ${String(row[subTitleH])}` : '';
                    else if (headers.length > 1) { const nextIdx = headers.indexOf(titleH) + 1; if(nextIdx < headers.length) { const nextH = headers[nextIdx]; subTitle = row[nextH] !== undefined && row[nextH] !== null ? `${escapeHTML(String(nextH))}: ${String(row[nextH])}` : '';}}
                }
                const avatarBg = isDarkMode ? 'var(--icon-dark)' : 'var(--icon-light)';
                const avatarTxt = isDarkMode ? 'var(--button-primary-text-dark)' : 'var(--button-primary-text-light)';
                const titleCol = isDarkMode ? 'var(--icon-dark)' : 'var(--icon-light)'; 
                const secondaryTxtCol = isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)';
                const borderCol = isDarkMode ? 'var(--border-dark)' : 'var(--border-light)';
                const sourceTxtCol = isDarkMode ? '#9ca3af' : '#a1a1aa'; 

                let cardHTML = `<div class="flex items-start space-x-3 sm:space-x-4"><div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 text-xl sm:text-2xl font-semibold rounded-full flex items-center justify-center uppercase" style="background-color: ${avatarBg}; color: ${avatarTxt};">${escapeHTML(String(mainTitle).charAt(0))}</div><div class="flex-grow min-w-0"><h3 class="text-md sm:text-lg font-semibold truncate result-title" title="${escapeHTML(String(mainTitle))}" style="color: ${titleCol};">${escapeHTML(String(mainTitle))}</h3>`;
                 if (subTitle) cardHTML += `<p class="text-xs sm:text-sm truncate result-subtitle" title="${escapeHTML(String(subTitle))}" style="color: ${secondaryTxtCol};">${escapeHTML(String(subTitle))}</p>`;
                cardHTML += `<p class="text-xs mt-0.5 result-source-text" style="color: ${sourceTxtCol};">Source: ${escapeHTML(meta ? `${meta.originalFileName} (${meta.sheetName})` : row.fileName)}</p></div></div><div class="mt-3 pt-3 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1.5 text-xs sm:text-sm result-details-grid" style="border-top: 1px solid ${borderCol};">`;
                const displayHeaders = headers.filter(h => !h.startsWith('_') && h !== 'id' && h !== 'fileName');
                displayHeaders.forEach(header => {
                    const cellValue = row[header] !== undefined && row[header] !== null ? row[header] : '';
                    let displayValue = escapeHTML(String(cellValue));
                    const lowerHeader = String(header).toLowerCase();
                    let valueStyle = `color: ${isDarkMode ? 'var(--text-primary-dark)' : 'var(--text-primary-light)'};`;
                    let isStyledValue = false;
                    if (lowerHeader === 'mrp' || lowerHeader.includes('price') || lowerHeader.includes('rate')) { valueStyle = `color: ${isDarkMode ? '#60a5fa' : '#2563eb'}; font-weight: 600;`; const numV = parseFloat(cellValue); if (!isNaN(numV)) displayValue = `â‚¹${numV.toFixed(2)}`; isStyledValue = true;
                    } else if (lowerHeader === 'stock' || lowerHeader.includes('qty') || lowerHeader.includes('quantity') || lowerHeader.includes('bal')) { const stockV = parseInt(cellValue); if (!isNaN(stockV)) { if (stockV > 20) valueStyle = `color: ${isDarkMode ? '#34d399' : '#059669'}; font-weight: 600;`; else if (stockV > 0) valueStyle = `color: ${isDarkMode ? '#facc15' : '#f59e0b'}; font-weight: 600;`; else valueStyle = `color: ${isDarkMode ? '#f87171' : '#ef4444'}; font-weight: 600;`; displayValue = String(stockV);} isStyledValue = true;
                    } else if (cellValue instanceof Date) { displayValue = cellValue.toLocaleString(); }
                    cardHTML += `<div class="flex justify-between items-center py-0.5"><span class="font-medium capitalize result-detail-header" style="color: ${secondaryTxtCol};">${escapeHTML(String(header))}:</span><span class="text-right truncate ml-2 result-detail-value" title="${escapeHTML(String(cellValue))}" style="${valueStyle}" ${isStyledValue ? `data-styled-value="true" data-header="${escapeHTML(header)}" data-value="${escapeHTML(String(cellValue))}"` : ''}>${displayValue}</span></div>`;
                });
                cardHTML += `</div></div>`; 
                rowEl.innerHTML = cardHTML; fragment.appendChild(rowEl);
            });
            resultsArea.appendChild(fragment); resultsDisplayed = endIndex; 
            if (resultsDisplayed < allSearchResults.length) { 
                const loadMoreBtn = document.createElement('button'); loadMoreBtn.id = 'loadMoreButton'; loadMoreBtn.textContent = `Load More (${allSearchResults.length - resultsDisplayed} remaining)`;
                loadMoreBtn.className = `w-full py-3 px-4 mt-4 text-sm font-semibold rounded-lg shadow-md transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2`;
                loadMoreBtn.style.cssText = `background-color: ${isDarkMode ? 'var(--button-primary-bg-dark)' : 'var(--button-primary-bg-light)'}; color: ${isDarkMode ? 'var(--button-primary-text-dark)' : 'var(--button-primary-text-light)'}; --tw-ring-color: ${isDarkMode ? 'var(--icon-dark)' : 'var(--icon-light)'};`;
                loadMoreBtn.onclick = () => displayResultsChunk(LOAD_MORE_CHUNK_SIZE); resultsArea.appendChild(loadMoreBtn);
            }
            const totalFound = allSearchResults.length; const durMatch = searchStatus.textContent.match(/in (\d+\.?\d*) ms/); const durTxt = durMatch ? ` in ${durMatch[1]} ms` : '';
            if (totalFound === 0) searchStatus.textContent = `Found 0 results${durTxt}.`;
            else if (totalFound > resultsDisplayed) searchStatus.textContent = `Found ${totalFound} results. Showing ${resultsDisplayed}...${durTxt}`;
            else searchStatus.textContent = `Found ${totalFound} results${durTxt}.`;
        }
        async function updateResultsDisplay() { 
            resultsArea.innerHTML = ''; allSearchResults = []; resultsDisplayed = 0;
            const isDarkMode = document.documentElement.classList.contains('dark');
            const msgEl = defaultResultsMessageElement.cloneNode(true); msgEl.style.display = 'block'; 
            let msgText = '', msgIcon = 'fas fa-info-circle';
            if (searchBox.value.trim().length > 0) { msgText = 'No results found for your search.'; msgIcon = 'fas fa-search-minus'; }
            else { const fileCount = await db[METADATA_STORE_NAME].count(); if (fileCount > 0) { msgText = 'Type to search stored files.'; msgIcon = 'fas fa-keyboard';} else { msgText = 'Upload an Excel file to start.'; msgIcon = 'fas fa-file-upload';}}
            msgEl.innerHTML = `<i class="${msgIcon} mr-2 text-3xl block mb-3" style="color: ${isDarkMode ? 'var(--input-placeholder-dark)' : 'var(--input-placeholder-light)'};"></i>${escapeHTML(msgText)}`;
            msgEl.style.backgroundColor = isDarkMode ? 'var(--bg-secondary-dark)' : 'var(--bg-secondary-light)';
            msgEl.style.color = isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)';
            resultsArea.appendChild(msgEl);
        }
        async function loadStoredFilesList() { 
            updateFooterStatus('Loading stored files...'); const isDarkMode = document.documentElement.classList.contains('dark');
            try {
                const metadata = await db[METADATA_STORE_NAME].orderBy('originalFileName').toArray(); storedFilesList.innerHTML = ''; 
                if (metadata.length === 0) { const noFilesEl = noFilesMessageElement.cloneNode(true); noFilesEl.style.display = 'flex'; noFilesEl.style.color = isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)'; noFilesEl.querySelector('i').style.color = isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)'; storedFilesList.appendChild(noFilesEl); }
                else { const existingNoFilesMsg = storedFilesList.querySelector('#noFilesMessage'); if(existingNoFilesMsg) existingNoFilesMsg.style.display = 'none';
                    metadata.forEach(meta => { const itemEl = document.createElement('div'); itemEl.className = 'file-item'; const fileNameText = document.createElement('span'); fileNameText.className = 'file-name-text flex-grow'; fileNameText.textContent = `${meta.originalFileName} (${meta.sheetName})`; const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-button'; deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>'; deleteBtn.onclick = () => deleteFileData(meta.fileName); itemEl.appendChild(fileNameText); itemEl.appendChild(deleteBtn); storedFilesList.appendChild(itemEl); });
                }
            } catch (error) { console.error("Error loading stored files:", error); showToast("Could not load stored files.", 'error'); storedFilesList.innerHTML = `<div class="file-item italic p-4" style="color: ${isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)'};"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading files.</div>`; }
            finally { updateFooterStatus('Ready'); }
        }
        async function deleteFileData(fileIdentifier) { if (confirm(`Delete all data from "${fileIdentifier.split("::")[0]}" (Sheet: "${fileIdentifier.split("::")[1]}")? This cannot be undone.`)) await deleteFileDataInternal(fileIdentifier, true); }
        async function deleteFileDataInternal(fileIdentifier, showUserFeedback = true) { 
             updateFooterStatus(`Deleting ${fileIdentifier}...`);
            try { await db.transaction('rw', db[STORE_NAME], db[METADATA_STORE_NAME], async () => { await db[STORE_NAME].where('fileName').equals(fileIdentifier).delete(); await db[METADATA_STORE_NAME].delete(fileIdentifier); }); if (showUserFeedback) showToast(`"${fileIdentifier.split("::")[0]}" (Sheet: "${fileIdentifier.split("::")[1]}") deleted.`, 'success'); await loadStoredFilesList(); const currentQuery = searchBox.value.trim(); const affectedResults = allSearchResults.filter(row => row.fileName === fileIdentifier); if (affectedResults.length > 0 || currentQuery.length > 0) handleSearch(); else updateResultsDisplay(); 
            } catch (error) { console.error("Error deleting file data:", error); if (showUserFeedback) showToast(`Error deleting file: ${error.message}`, 'error'); }
            finally { updateFooterStatus('Ready'); }
        }
        function updateFooterStatus(message) { if(footerStatus) footerStatus.textContent = message; }

        // --- Data Map Modal Functionality ---
        function initializeDataMapModalListeners() {
            closeDataMapModalBtn.addEventListener('click', () => dataMapModal.classList.add('hidden'));
            dataMapModal.addEventListener('click', (event) => { if (event.target.id === 'dataMapModal') dataMapModal.classList.add('hidden'); });
        }

        async function handleResultCardClick(event) {
            const card = event.currentTarget; 
            const rowId = parseInt(card.dataset.rowId);
            const fileName = card.dataset.fileName;
            if (!rowId || !fileName) { showToast("Could not load details for this item.", "error"); return; }
            updateFooterStatus('Loading item details...');
            try {
                const clickedRowData = await db[STORE_NAME].get(rowId);
                if (!clickedRowData) throw new Error("Item data not found in database.");
                await showDataMapModal(clickedRowData);
            } catch (error) {
                console.error("Error handling result card click:", error); showToast(`Error loading details: ${error.message}`, 'error');
            } finally { updateFooterStatus('Ready'); }
        }
        
        function findKeyField(headersArray, commonNamesArray, excludeField = null) {
            if (!headersArray || !commonNamesArray) return null;
            for (const header of headersArray) {
                if (header === excludeField) continue;
                const lowerHeader = header.toLowerCase().trim();
                if (commonNamesArray.some(commonName => lowerHeader === commonName.toLowerCase())) {
                     return header;
                }
            }
            for (const header of headersArray) {
                if (header === excludeField) continue;
                const lowerHeader = header.toLowerCase().trim();
                if (commonNamesArray.some(commonName => lowerHeader.includes(commonName.toLowerCase()))) {
                    return header;
                }
            }
            return null;
        }


        async function showDataMapModal(clickedRow) {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const loadingHTML = `<div class="modal-loading p-4 text-center" style="color: ${isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)'};"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</div>`;
            modalSelectedItemContent.innerHTML = loadingHTML;
            modalCompanyInsightsContent.innerHTML = loadingHTML;
            modalSimilarItemsContent.innerHTML = loadingHTML;
            
            dataMapModal.classList.remove('hidden');
            applyTheme(localStorage.getItem('theme') || (prefersDarkScheme.matches ? 'dark' : 'light')); 

            updateFooterStatus('Populating data map...');
            try {
                const metadata = await db[METADATA_STORE_NAME].get(clickedRow.fileName);
                const headers = metadata ? metadata.headers : Object.keys(clickedRow).filter(k => !k.startsWith('_') && k !== 'id' && k !== 'fileName');
                const itemNameFieldForTitle = findKeyField(headers, ['item name', 'product', 'title', 'name', 'item']); // Added 'item'
                dataMapModalTitle.textContent = itemNameFieldForTitle && clickedRow[itemNameFieldForTitle] ? `Details: ${escapeHTML(String(clickedRow[itemNameFieldForTitle]).substring(0,50))}` : 'Data Details';

                populateSelectedItemDetails(modalSelectedItemContent, clickedRow, headers, isDarkMode);
                await fetchAndDisplayCompanyInsights(modalCompanyInsightsContent, clickedRow, headers, isDarkMode);
                await fetchAndDisplaySimilarItems(modalSimilarItemsContent, clickedRow, headers, isDarkMode); 
            } catch (error) {
                console.error("Error populating data map modal:", error); showToast(`Error displaying details: ${error.message}`, 'error');
                modalSelectedItemContent.innerHTML = `<p class="text-red-500 p-4">Error loading details.</p>`;
                modalCompanyInsightsContent.innerHTML = `<p class="text-red-500 p-4">Error loading company insights.</p>`;
                modalSimilarItemsContent.innerHTML = `<p class="text-red-500 p-4">Error loading similar items.</p>`;
            } finally { updateFooterStatus('Ready'); }
        }

        function populateSelectedItemDetails(element, itemData, headers, isDarkMode) {
            element.innerHTML = ''; 
            let html = '';
            headers.forEach(header => {
                if (header === '_searchableTokens' || header === 'fileName' || header === 'id') return;
                const value = itemData[header] !== undefined && itemData[header] !== null ? itemData[header] : 'N/A';
                html += `<div class="flex justify-between py-1 modal-item-detail"><span class="font-medium capitalize" style="color: ${isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)'};">${escapeHTML(header)}:</span><span class="text-right ml-2 truncate" title="${escapeHTML(String(value))}" style="color: ${isDarkMode ? 'var(--text-primary-dark)' : 'var(--text-primary-light)'};">${escapeHTML(String(value))}</span></div>`;
            });
            element.innerHTML = html || `<p class="text-xs italic modal-no-data" style="color: ${isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)'};">No details to display.</p>`;
        }

        async function fetchAndDisplayCompanyInsights(element, clickedRow, allHeaders, isDarkMode) {
            const companyFieldName = findKeyField(allHeaders, ['company', 'manufacturer', 'brand', 'make']);
            const itemTypeFieldName = findKeyField(allHeaders, ['category', 'type', 'item type', 'product line', 'item category'], companyFieldName);
            const noDataColor = isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)';

            if (!companyFieldName || clickedRow[companyFieldName] === undefined || clickedRow[companyFieldName] === "" ) {
                element.innerHTML = `<p class="text-xs italic modal-no-data" style="color: ${noDataColor};">Company field not identified or no company name for this item.</p>`;
                return;
            }
            const companyName = clickedRow[companyFieldName];
            let html = `<p class="font-semibold mb-2 modal-company-total" style="color: ${isDarkMode ? 'var(--text-primary-dark)' : 'var(--text-primary-light)'};">Company: ${escapeHTML(String(companyName))}</p>`;
            try {
                const companyItems = await db[STORE_NAME].where({ fileName: clickedRow.fileName }).filter(item => item[companyFieldName] === companyName).toArray();
                if (companyItems.length === 0) { 
                    element.innerHTML = `<p class="text-xs italic modal-no-data" style="color: ${noDataColor};">No items found for this company (${escapeHTML(String(companyName))}) in this file.</p>`; return;
                }
                html += `<p class="mb-1 modal-company-total" style="color: ${isDarkMode ? 'var(--text-primary-dark)' : 'var(--text-primary-light)'};">Total items from this company (in this file): ${companyItems.length}</p>`;
                if (itemTypeFieldName) {
                    html += `<p class="mt-2 mb-1 font-medium" style="color: ${isDarkMode ? 'var(--text-primary-dark)' : 'var(--text-primary-light)'};">Item Types/Categories:</p><div class="space-y-0.5">`;
                    const itemTypesCount = {}; companyItems.forEach(item => { const type = item[itemTypeFieldName] || 'Uncategorized'; itemTypesCount[type] = (itemTypesCount[type] || 0) + 1; });
                    Object.entries(itemTypesCount).forEach(([type, count]) => { html += `<div class="flex justify-between text-xs modal-company-type"><span style="color: ${isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)'};">${escapeHTML(String(type))}:</span><span style="color: ${isDarkMode ? 'var(--text-primary-dark)' : 'var(--text-primary-light)'};">${count}</span></div>`; });
                    html += `</div>`;
                } else { html += `<p class="text-xs italic mt-1 modal-no-data" style="color: ${noDataColor};">Item type/category field not identified.</p>`; }
                element.innerHTML = html;
            } catch (err) { console.error("Error fetching company insights:", err); element.innerHTML = `<p class="text-red-500">Error loading company data.</p>`; }
        }

        async function fetchAndDisplaySimilarItems(element, clickedRow, allHeaders, isDarkMode) {
            const noDataColor = isDarkMode ? 'var(--text-secondary-dark)' : 'var(--text-secondary-light)';
            
            // MODIFIED LINE: Added 'item' to the common names list
            const itemIdentifierFieldName = findKeyField(allHeaders, ['item name', 'product', 'description', 'title', 'model', 'part number', 'sku', 'name', 'item']);
            const locationFieldName = findKeyField(allHeaders, ['location', 'site', 'warehouse', 'address1', 'store']);
            const location2FieldName = findKeyField(allHeaders, ['location2', 'sub-location', 'zone', 'address2', 'aisle', 'shelf']);

            if (!itemIdentifierFieldName) {
                element.innerHTML = `<p class="text-xs italic modal-no-data" style="color: ${noDataColor};">Cannot determine a key identifier column for similarity in this file's headers.</p>`;
                return;
            }

            const mainItemIdentifierValue = String(clickedRow[itemIdentifierFieldName] || '').trim();

            if (!mainItemIdentifierValue) {
                element.innerHTML = `<p class="text-xs italic modal-no-data" style="color: ${noDataColor};">The key identifier for this specific item is empty; cannot find similar items.</p>`;
                return;
            }

            const mainItemTokens = mainItemIdentifierValue.toLowerCase().split(/\s+/).filter(t => t.length > 0);
            if (mainItemTokens.length === 0) {
                element.innerHTML = `<p class="text-xs italic modal-no-data" style="color: ${noDataColor};">Cannot extract comparable terms from this item's identifier.</p>`;
                return;
            }
            
            const primaryToken = mainItemTokens[0]; 

            try {
                const candidateItems = await db[STORE_NAME]
                    .where('_searchableTokens').equals(primaryToken) 
                    .filter(item => item.fileName === clickedRow.fileName && item.id !== clickedRow.id) 
                    .toArray();

                const similarItems = candidateItems.filter(item => {
                    const candidateIdentifierValue = String(item[itemIdentifierFieldName] || '').trim().toLowerCase();
                    if (!candidateIdentifierValue) return false;
                    const candidateTokens = candidateIdentifierValue.split(/\s+/).filter(t => t.length > 0);
                    return candidateTokens.length > 0 && candidateTokens[0] === primaryToken;
                });

                if (similarItems.length === 0) {
                    element.innerHTML = `<p class="text-xs italic modal-no-data" style="color: ${noDataColor};">No other items found starting with "${escapeHTML(primaryToken)}" in the identifier column within this file.</p>`;
                    return;
                }
                
                let html = `<p class="mb-2 font-medium" style="color: ${isDarkMode ? 'var(--text-primary-dark)' : 'var(--text-primary-light)'};">Found ${similarItems.length} other item(s) in this file potentially related to "${escapeHTML(primaryToken)}...":</p><div class="space-y-2">`;
                similarItems.forEach(item => {
                    const itemDisplayIdentifier = String(item[itemIdentifierFieldName] || 'N/A');
                    html += `<div class="p-2 border rounded-md" style="border-color: ${isDarkMode ? 'var(--border-dark)' : 'var(--border-light)'}; background-color: ${isDarkMode ? 'var(--bg-secondary-dark)' : 'var(--bg-secondary-light)'};">
                                <p class="font-semibold text-sm modal-similar-item-name" style="color: ${isDarkMode ? 'var(--text-primary-dark)' : 'var(--text-primary-light)'};" title="${escapeHTML(itemDisplayIdentifier)}">
                                    ${escapeHTML(itemDisplayIdentifier.substring(0,60))}${itemDisplayIdentifier.length > 60 ? '...' : ''}
                                </p>`;
                    
                    let locInfo = '';
                    const loc1Value = item[locationFieldName];
                    const loc2Value = item[location2FieldName];

                    if (locationFieldName && loc1Value !== undefined && String(loc1Value).trim() !== "") {
                        locInfo += `Location: ${escapeHTML(String(loc1Value))}`;
                    }
                    if (location2FieldName && loc2Value !== undefined && String(loc2Value).trim() !== "") {
                        locInfo += (locInfo ? ' | ' : 'Location2: ') + `${escapeHTML(String(loc2Value))}`;
                    }

                    if (locInfo) {
                        html += `<p class="text-xs mt-1 modal-similar-item-loc" style="color: ${noDataColor};">${locInfo}</p>`;
                    } else {
                        html += `<p class="text-xs mt-1 italic modal-similar-item-loc" style="color: ${noDataColor};">Location information not available or not identified.</p>`;
                    }
                    html += `</div>`;
                });
                html += `</div>`;
                element.innerHTML = html;

            } catch (err) {
                console.error("Error fetching similar items:", err);
                element.innerHTML = `<p class="text-red-500 p-3">Error loading similar items. Check console for details.</p>`;
                showToast("Error fetching similar items.", "error");
            }
        }

    </script>
</body>
</html>
